name: Build and Test

on:
  pull_request:
    branches: [ "main", "dev" ]
  workflow_dispatch:

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Git (for act)
      run: |
        if ! command -v git &> /dev/null; then
            if [ "$(id -u)" -eq 0 ]; then
                apt-get update && apt-get install -y git
            else
                sudo apt-get update && sudo apt-get install -y git
            fi
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Circom
      run: |
        SUDO=""
        if [ "$(id -u)" -ne 0 ]; then
            SUDO="sudo"
        fi
        
        $SUDO rm -f /etc/apt/sources.list.d/microsoft-prod.list
        $SUDO apt-get update
        $SUDO apt-get install -y wget nlohmann-json3-dev libgmp-dev nasm g++ build-essential
        $SUDO wget -q https://github.com/iden3/circom/releases/download/v2.1.9/circom-linux-amd64 -O /usr/bin/circom
        $SUDO chmod +x /usr/bin/circom
        circom --version

    - name: Verify Circuits Compile
      run: |
        npx circomkit compile prove_score_inclusion
        npx circomkit compile batch_main

    - name: Run JS/Circuit Tests
      run: npm run test:all
